<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RUN: POKEMON CLUB ULTIMATE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        main: 'var(--bg-main)',       // 배경
                        card: 'var(--bg-card)',       // 카드 배경
                        accent: 'var(--accent)',      // 포인트 컬러 (야광/파랑)
                        txt: 'var(--text-main)',      // 메인 텍스트
                        sub: 'var(--text-sub)',       // 서브 텍스트
                        line: 'var(--border-color)',  // 테두리
                    },
                    fontFamily: {
                        sport: ['Chakra Petch', 'sans-serif'],
                        base: ['Noto Sans KR', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* === 테마 변수 정의 === */
        :root {
            /* 기본: 다크 모드 (Night) */
            --bg-main: #050505;
            --bg-card: rgba(25, 25, 25, 0.85);
            --text-main: #ffffff;
            --text-sub: #9ca3af;
            --accent: #ccff00; /* Volt Green */
            --border-color: rgba(255, 255, 255, 0.1);
            
            --rank-s: #a855f7; 
            --rank-a: #eab308;
            --rank-b: #3b82f6; 
            --rank-c: #9ca3af; 
        }

        /* 라이트 모드 (Day) */
        [data-theme="light"] {
            --bg-main: #f0f4f8;
            --bg-card: rgba(255, 255, 255, 0.85);
            --text-main: #1a1a1a;
            --text-sub: #4b5563;
            --accent: #2563eb; /* Bright Blue */
            --border-color: rgba(0, 0, 0, 0.1);

            --rank-s: #9333ea; 
            --rank-a: #d97706;
            --rank-b: #2563eb; 
            --rank-c: #6b7280; 
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 글래스모피즘 효과 */
        .glass {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: background 0.3s, border-color 0.3s;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* 애니메이션 */
        @keyframes shake-ball {
            0% { transform: translate(0, 0) rotate(0); }
            20% { transform: translate(-3px, 0) rotate(-10deg); }
            40% { transform: translate(3px, 0) rotate(10deg); }
            60% { transform: translate(-3px, 0) rotate(-10deg); }
            80% { transform: translate(3px, 0) rotate(10deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }
        .anim-shake { animation: shake-ball 0.5s infinite; }
        .anim-pop { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* 배틀 애니메이션 */
        @keyframes lunge-right { 0% { transform: scaleX(-1) translateX(0); } 50% { transform: scaleX(-1) translateX(-80px); } 100% { transform: scaleX(-1) translateX(0); } }
        @keyframes lunge-left { 0% { transform: scaleX(1) translateX(0); } 50% { transform: scaleX(1) translateX(80px); } 100% { transform: scaleX(1) translateX(0); } }
        @keyframes damage { 0% { filter: brightness(1); } 50% { filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5); transform: translateX(-5px); } 100% { filter: brightness(1); transform: translateX(0); } }

        .anim-atk-p { animation: lunge-right 0.3s ease-in-out; }
        .anim-atk-e { animation: lunge-left 0.3s ease-in-out; }
        .anim-dmg { animation: damage 0.3s ease-out; }

        /* 스프라이트 */
        .sprite-player { transform: scaleX(-1); filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); }
        .sprite-enemy { filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); }
        .sprite-dead { filter: grayscale(1) brightness(0.3); opacity: 0.5; transition: all 1s; }

        /* 등급 텍스트 */
        .rank-S { color: var(--rank-s); font-weight: 900; }
        .rank-A { color: var(--rank-a); font-weight: 800; }
        .rank-B { color: var(--rank-b); font-weight: 700; }
        .rank-C { color: var(--rank-c); font-weight: 600; }

        /* 네비게이션 활성 상태 (테마별 색상 적용) */
        .nav-active { color: var(--accent) !important; transform: translateY(-4px); }
    </style>
</head>
<body class="flex justify-center h-screen w-full bg-gray-800">

    <div id="app" class="relative w-full max-w-md h-full bg-main shadow-2xl overflow-hidden flex flex-col border-x border-line transition-colors duration-300">
        
        <header id="main-header" class="absolute top-0 w-full z-30 px-5 py-4 flex justify-between items-center glass border-b border-line">
            <div class="flex items-center gap-2">
                <div class="bg-accent p-1 rounded text-white shadow-lg transition-colors duration-300">
                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i>
                </div>
                <h1 class="text-xl font-sport font-black italic tracking-tighter text-txt">POKE<span class="text-accent">RUN</span></h1>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="app.toggleTheme()" class="p-2 rounded-full bg-gray-200/20 hover:bg-gray-200/40 transition-colors">
                    <i id="theme-icon" data-lucide="sun" class="w-5 h-5 text-txt"></i>
                </button>
                
                <div class="flex items-center gap-2 bg-black/10 px-4 py-1.5 rounded-full border border-line">
                    <span class="text-yellow-400 text-xs font-bold">●</span>
                    <span id="display-coins" class="font-sport font-bold text-sm text-txt">0</span>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-1 relative overflow-y-auto scrollbar-hide pt-16 pb-24 bg-main transition-colors duration-300">
            </main>

        <nav id="main-nav" class="absolute bottom-0 w-full glass border-t border-line px-2 py-2 flex justify-around items-end z-40 pb-6 transition-colors duration-300">
            <button onclick="app.nav('lobby')" id="nav-lobby" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">HOME</span>
            </button>
            <button onclick="app.nav('team')" id="nav-team" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">TEAM</span>
            </button>
            <button onclick="app.nav('battle')" class="mb-4 transform transition-transform active:scale-95 group">
                <div class="w-16 h-16 bg-accent rounded-full flex items-center justify-center border-4 border-main shadow-xl relative z-10 group-hover:scale-105 transition-all">
                    <i data-lucide="swords" class="w-8 h-8 text-white fill-current"></i>
                </div>
            </button>
            <button onclick="app.nav('shop')" id="nav-shop" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">SHOP</span>
            </button>
            <button onclick="app.nav('dex')" id="nav-dex" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 transition-all text-sub hover:text-txt">
                <i data-lucide="book-open" class="w-6 h-6"></i>
                <span class="text-[10px] font-black italic font-sport">DEX</span>
            </button>
        </nav>

        <div id="toast" class="absolute top-24 left-1/2 -translate-x-1/2 bg-accent text-white px-6 py-3 rounded-full font-black italic shadow-2xl transform scale-0 transition-transform z-50 pointer-events-none text-sm whitespace-nowrap border-2 border-white flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4"></i>
            <span id="toast-msg">Notification</span>
        </div>
    </div>

    <script>
        // --- 유틸리티 ---
        const $ = (id) => document.getElementById(id);
        const wait = (ms) => new Promise(r => setTimeout(r, ms));
        const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // 토스트 메시지
        window.showToast = function(msg, type='success') {
            const t = $('toast');
            if(!t) return;
            const msgEl = $('toast-msg');
            msgEl.innerText = msg;
            
            // 타입별 색상 조정 (테일윈드 클래스 대신 직접 스타일 제어)
            t.style.backgroundColor = type === 'error' ? '#ef4444' : 'var(--accent)'; // Red or Accent
            
            requestAnimationFrame(() => t.style.transform = 'translate(-50%, 0) scale(1)');
            setTimeout(() => t.style.transform = 'translate(-50%, 0) scale(0)', 2500);
        };

        // --- 데이터 ---
        const BALLS = [
            { id: 'poke', name: 'Poké Ball', price: 200, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png', rates: {S: 0, A: 5, B: 20, C: 75}, color: 'border-gray-500' },
            { id: 'great', name: 'Great Ball', price: 500, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png', rates: {S: 5, A: 15, B: 40, C: 40}, color: 'border-blue-500' },
            { id: 'ultra', name: 'Ultra Ball', price: 1500, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png', rates: {S: 15, A: 45, B: 30, C: 10}, color: 'border-yellow-500' },
            { id: 'master', name: 'Master Ball', price: 5000, img: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png', rates: {S: 100, A: 0, B: 0, C: 0}, color: 'border-purple-500' }
        ];

        const state = {
            coins: 5000,
            inventory: [],
            team: [null, null, null],
            battle: { active: false },
            theme: 'dark' // 'dark' or 'light'
        };

        // --- 앱 로직 ---
        const app = {
            init: () => {
                // 초기 포켓몬
                if(state.inventory.length === 0) {
                    app.addPokemon({id: 25, name: 'Pikachu', type: 'Electric', rank: 'A', hp: 100, atk: 55}, true);
                    app.addPokemon({id: 6, name: 'Charizard', type: 'Fire', rank: 'S', hp: 160, atk: 90}, true);
                    app.addPokemon({id: 9, name: 'Blastoise', type: 'Water', rank: 'A', hp: 140, atk: 75}, true);
                    state.team = [state.inventory[1], state.inventory[0], state.inventory[2]];
                }
                app.updateCoins(0);
                app.nav('lobby');
                
                // 테마 초기화
                app.applyTheme();
            },

            // 테마 전환 함수
            toggleTheme: () => {
                state.theme = state.theme === 'dark' ? 'light' : 'dark';
                app.applyTheme();
            },

            applyTheme: () => {
                const root = document.documentElement;
                const icon = $('theme-icon');
                
                if (state.theme === 'light') {
                    root.setAttribute('data-theme', 'light');
                    icon.setAttribute('data-lucide', 'moon'); // 라이트모드일 때 달 아이콘 표시
                } else {
                    root.removeAttribute('data-theme');
                    icon.setAttribute('data-lucide', 'sun'); // 다크모드일 때 해 아이콘 표시
                }
                lucide.createIcons();
            },

            addPokemon: (pkm, silent=false) => {
                pkm.uid = Date.now() + Math.random();
                pkm.sprite = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/${pkm.id}.gif`;
                pkm.static = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pkm.id}.png`;
                pkm.level = 1;
                pkm.maxHp = pkm.hp;
                pkm.currentHp = pkm.hp;
                
                state.inventory.push(pkm);
                if(!silent) showToast(`Got ${pkm.name}!`);
            },

            updateCoins: (amt) => {
                state.coins += amt;
                $('display-coins').innerText = state.coins.toLocaleString();
            },

            nav: (view) => {
                const main = $('main-content');
                main.innerHTML = '';
                
                document.querySelectorAll('.nav-btn').forEach(b => {
                    const isActive = b.id === `nav-${view}`;
                    // 클래스 초기화 및 활성 클래스 추가
                    b.classList.remove('nav-active');
                    if(isActive) b.classList.add('nav-active');
                });

                if(view === 'lobby') app.renderLobby(main);
                if(view === 'shop') app.renderShop(main);
                if(view === 'dex') app.renderDex(main);
                if(view === 'team') app.renderTeam(main);
                if(view === 'battle') app.renderBattleSetup(main);
                
                lucide.createIcons();
            },

            // --- [VIEW] 로비 ---
            renderLobby: (c) => {
                const partner = state.team[0] || state.inventory[0];
                c.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-6 anim-pop">
                        <div class="relative w-full aspect-square flex items-center justify-center mb-6">
                            <div class="absolute inset-0 bg-${partner.rank==='S'?'purple':partner.rank==='A'?'yellow':'blue'}-500/20 blur-[80px] rounded-full animate-pulse"></div>
                            <img src="${partner.sprite}" class="w-64 h-64 object-contain relative z-10 sprite-player drop-shadow-2xl">
                        </div>
                        <h2 class="font-sport font-black italic text-5xl uppercase mb-2 text-txt drop-shadow-sm tracking-tighter">${partner.name}</h2>
                        
                        <div class="glass px-6 py-2 rounded-full flex items-center gap-3 mb-10">
                            <span class="font-black text-2xl italic rank-${partner.rank}">${partner.rank}</span>
                            <div class="h-4 w-[1px] bg-sub"></div>
                            <span class="text-xs font-bold text-sub uppercase tracking-widest">${partner.type}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 w-full">
                            <div class="glass p-5 rounded-2xl border-l-4 border-accent flex flex-col justify-between">
                                <p class="text-[10px] text-sub font-bold uppercase mb-1">Total Runs</p>
                                <p class="text-3xl font-sport font-black italic text-txt">42 <span class="text-sm text-sub not-italic">km</span></p>
                            </div>
                            <div class="glass p-5 rounded-2xl border-l-4 border-blue-500 flex flex-col justify-between">
                                <p class="text-[10px] text-sub font-bold uppercase mb-1">Win Rate</p>
                                <p class="text-3xl font-sport font-black italic text-txt">12 <span class="text-sm text-sub not-italic">Wins</span></p>
                            </div>
                        </div>
                    </div>
                `;
            },

            // --- [VIEW] 상점 ---
            renderShop: (c) => {
                const ballCards = BALLS.map(b => `
                    <div onclick="app.confirmBuy('${b.id}')" class="glass p-4 rounded-2xl flex flex-col items-center relative overflow-hidden group active:scale-95 transition-all cursor-pointer border-t-4 ${b.color}">
                        <div class="absolute top-2 right-2 text-[9px] font-black uppercase bg-black/50 px-2 py-0.5 rounded text-white border border-white/10">
                            ${b.id === 'master' ? '100% S-RANK' : `S: ${b.rates.S}%`}
                        </div>
                        <img src="${b.img}" class="w-20 h-20 object-contain mb-3 drop-shadow-lg group-hover:scale-110 transition-transform mt-2">
                        <h3 class="font-black italic text-lg uppercase text-txt mb-0.5">${b.name}</h3>
                        <p class="text-accent font-bold text-sm mb-3">${b.price.toLocaleString()} C</p>
                        
                        <div class="w-full flex h-1.5 rounded-full overflow-hidden bg-gray-300 dark:bg-gray-800 mb-1">
                            <div style="width:${b.rates.S}%" class="bg-purple-500"></div>
                            <div style="width:${b.rates.A}%" class="bg-yellow-500"></div>
                            <div style="width:${b.rates.B}%" class="bg-blue-500"></div>
                            <div style="width:${b.rates.C}%" class="bg-gray-400"></div>
                        </div>
                    </div>
                `).join('');

                c.innerHTML = `
                    <div class="p-5 pb-24 h-full flex flex-col anim-pop">
                        <h2 class="text-4xl font-sport font-black italic mb-2 text-txt tracking-tighter">ITEM SHOP</h2>
                        <p class="text-sub text-xs mb-6 font-bold uppercase">Better Balls = Better Ranks</p>
                        <div class="grid grid-cols-2 gap-3 overflow-y-auto pb-4">${ballCards}</div>
                    </div>
                `;
            },

            confirmBuy: async (ballId) => {
                const ball = BALLS.find(b => b.id === ballId);
                if(state.coins < ball.price) return showToast("Not enough coins!", "error");

                app.updateCoins(-ball.price);
                
                const overlay = document.createElement('div');
                overlay.className = "absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center anim-pop";
                overlay.innerHTML = `
                    <div class="relative mb-12">
                        <div class="absolute inset-0 bg-white/10 blur-3xl rounded-full animate-pulse"></div>
                        <img id="gacha-anim" src="${ball.img}" class="w-48 h-48 object-contain relative z-10 anim-shake">
                    </div>
                    <div class="text-white font-sport text-2xl animate-pulse tracking-widest">CATCHING...</div>
                `;
                $('app').appendChild(overlay);

                await wait(2000);

                const rand = Math.random() * 100;
                let rank = 'C';
                if (rand <= ball.rates.S) rank = 'S';
                else if (rand <= ball.rates.S + ball.rates.A) rank = 'A';
                else if (rand <= ball.rates.S + ball.rates.A + ball.rates.B) rank = 'B';

                const id = rnd(1, 151);
                const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`).then(r=>r.json());
                
                let bonus = rank === 'S' ? 60 : rank === 'A' ? 40 : rank === 'B' ? 20 : 0;
                const pkm = { id: id, name: res.name, type: res.types[0].type.name, rank: rank, hp: rnd(60, 100) + bonus, atk: rnd(40, 80) + bonus };
                app.addPokemon(pkm, true);

                overlay.innerHTML = `
                    <div class="text-accent font-sport text-6xl font-black italic mb-8 anim-pop">GOTCHA!</div>
                    <div class="relative mb-8">
                         <div class="absolute inset-0 bg-${rank === 'S' ? 'purple' : rank === 'A' ? 'yellow' : 'blue'}-500/30 blur-[60px] rounded-full"></div>
                         <img src="${pkm.sprite}" class="w-56 h-56 object-contain relative z-10 sprite-player">
                    </div>
                    <h2 class="text-3xl font-black italic uppercase text-white mb-2 tracking-tighter">${pkm.name}</h2>
                    <div class="glass px-6 py-2 rounded-full border border-white/20 flex gap-4 items-center mb-10">
                        <span class="font-black italic text-3xl rank-${rank}">${rank}</span>
                        <div class="w-[1px] h-6 bg-gray-500"></div>
                        <div class="flex flex-col items-start">
                            <span class="text-[10px] text-gray-300 font-bold uppercase">HP ${pkm.hp}</span>
                            <span class="text-[10px] text-gray-300 font-bold uppercase">ATK ${pkm.atk}</span>
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove()" class="bg-white text-black px-12 py-4 rounded-full font-black italic hover:scale-105 transition-transform shadow-xl">CLOSE</button>
                `;
            },

            // --- [VIEW] 팀 편성 ---
            renderTeam: (c) => {
                const slots = state.team.map((p, i) => `
                    <div onclick="app.selectSlot(${i})" class="glass h-32 rounded-xl flex items-center justify-center relative cursor-pointer border-2 transition-all ${window.selectedSlot === i ? 'border-accent bg-accent/10' : 'border-dashed border-line hover:border-sub'}">
                        ${p ? `
                            <img src="${p.sprite}" class="w-24 h-24 object-contain relative z-10 sprite-player">
                            <span class="absolute bottom-2 left-2 font-black italic text-xs uppercase text-txt drop-shadow-md">${p.name}</span>
                            <span class="absolute top-2 right-2 font-black italic text-sm rank-${p.rank}">${p.rank}</span>
                            <button onclick="event.stopPropagation(); app.setSlot(${i}, null)" class="absolute -top-2 -right-2 bg-red-500 rounded-full p-1 shadow-md hover:scale-110 transition-transform"><i data-lucide="x" class="w-3 h-3 text-white"></i></button>
                        ` : `<div class="text-sub font-bold text-xs flex flex-col items-center"><i data-lucide="plus" class="w-6 h-6 mb-1 opacity-50"></i>ADD</div>`}
                    </div>
                `).join('');

                const inv = state.inventory.map((p, i) => `
                    <div onclick="app.equip(${i})" class="glass p-2 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-black/5 dark:hover:bg-white/5 border border-transparent hover:border-accent transition-colors group">
                        <div class="w-12 h-12 bg-black/10 dark:bg-white/10 rounded-lg flex items-center justify-center">
                            <img src="${p.static}" class="w-10 h-10 object-contain">
                        </div>
                        <div class="flex-1">
                            <p class="font-black text-xs uppercase text-txt group-hover:text-accent transition-colors">${p.name}</p>
                            <p class="text-[10px] text-sub font-bold">Lv.${p.level} • <span class="rank-${p.rank}">${p.rank}</span></p>
                        </div>
                        ${state.team.some(t => t && t.uid === p.uid) ? '<i data-lucide="check-circle" class="w-4 h-4 text-accent"></i>' : ''}
                    </div>
                `).join('');

                c.innerHTML = `
                    <div class="p-5 pb-24 h-full flex flex-col anim-pop">
                        <div class="flex justify-between items-end mb-4">
                            <h2 class="text-3xl font-sport font-black italic text-txt tracking-tighter">MY TEAM</h2>
                            <span class="text-[10px] bg-card px-2 py-1 rounded text-sub font-bold border border-line">3 / 3 SLOTS</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-6">${slots}</div>
                        <div class="flex-1 overflow-y-auto border-t border-line pt-4">
                            <h3 class="font-black italic text-accent mb-3 text-sm">INVENTORY (${state.inventory.length})</h3>
                            <div class="grid grid-cols-1 gap-2">${inv}</div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            // --- [VIEW] 도감 ---
            renderDex: (c) => {
                c.innerHTML = `
                    <div class="p-6 pb-24 anim-pop">
                        <h2 class="text-3xl font-sport font-black italic mb-6 text-txt tracking-tighter">POKEDEX</h2>
                        <div class="grid grid-cols-2 gap-3">
                            ${state.inventory.map(p => `
                                <div class="glass p-3 rounded-xl flex flex-col items-center relative overflow-hidden group">
                                    <div class="absolute top-2 right-2 rank-${p.rank} font-black italic text-lg opacity-80">${p.rank}</div>
                                    <img src="${p.static}" class="w-20 h-20 object-contain mb-2 drop-shadow-md group-hover:scale-110 transition-transform">
                                    <span class="font-black text-xs uppercase text-txt tracking-wider">${p.name}</span>
                                    <span class="text-[10px] text-accent bg-black/5 px-2 py-0.5 rounded mt-1 border border-line">${p.type}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            // --- [VIEW] 배틀 셋업 ---
            renderBattleSetup: (c) => {
                const ready = state.team.filter(p=>p).length === 3;
                c.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-6 anim-pop text-center bg-[url('https://images.unsplash.com/photo-1620108097950-8b4382559530?auto=format&fit=crop&w=800&q=80')] bg-cover bg-center">
                        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
                        <div class="relative z-10 w-full flex flex-col items-center">
                            <h2 class="text-7xl font-sport font-black italic text-white mb-1 leading-none">3 VS 3</h2>
                            <p class="text-gray-300 font-bold text-xs tracking-[0.3em] mb-12">AUTO BATTLE SYSTEM</p>
                            <div class="flex justify-center gap-3 mb-12">
                                ${state.team.map(p => `
                                    <div class="w-20 h-20 glass rounded-xl border-2 ${p ? 'border-accent bg-accent/20' : 'border-red-500/30 bg-red-500/10'} flex items-center justify-center relative shadow-lg">
                                        ${p ? `<img src="${p.sprite}" class="w-16 h-16 object-contain sprite-player relative z-10">` : '<i data-lucide="plus" class="text-gray-400"></i>'}
                                    </div>
                                `).join('')}
                            </div>
                            ${ready ? `<button onclick="app.startBattle()" class="w-full max-w-xs bg-accent text-white font-black italic text-xl py-5 rounded-full shadow-lg hover:scale-105 transition-transform">START MATCH</button>` : `<button onclick="app.nav('team')" class="w-full max-w-xs bg-gray-800 text-gray-500 font-bold text-lg py-5 rounded-full border border-gray-700 hover:bg-gray-700 transition-colors">TEAM INCOMPLETE</button>`}
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            // --- [CORE] 배틀 로직 ---
            startBattle: async () => {
                state.battle.active = true;
                state.battle.myTeam = state.team.map(p => ({...p, currentHp: p.hp}));
                
                const enemies = [];
                for(let i=0; i<3; i++) {
                    const id = rnd(1, 151);
                    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`).then(r=>r.json());
                    enemies.push({ id: id, name: res.name, sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/${id}.gif`, hp: 100, maxHp: 100, currentHp: 100 });
                }
                state.battle.enemyTeam = enemies;
                app.renderBattleArena($('main-content'));
                app.battleLoop();
            },

            renderBattleArena: (c) => {
                const renderUnit = (p, i, isP) => `
                    <div id="unit-${isP?'p':'e'}-${i}" class="relative w-28 flex flex-col items-center transition-all duration-300">
                        <div class="w-24 h-2 bg-gray-800/80 rounded-full mb-2 overflow-hidden border border-white/20"><div id="hp-${isP?'p':'e'}-${i}" class="h-full bg-accent" style="width:${(p.currentHp/p.maxHp)*100}%"></div></div>
                        <div class="relative w-28 h-28 flex items-center justify-center">
                            <img src="${p.sprite}" class="w-full h-full object-contain ${isP?'sprite-player':'sprite-enemy'} z-10 relative">
                        </div>
                    </div>
                `;
                c.innerHTML = `
                    <div class="relative h-full w-full bg-gray-900 flex flex-col overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1000')] bg-cover bg-center opacity-40"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/80"></div>
                        <div class="relative z-10 flex justify-end gap-1 p-6 pt-10 pr-4 perspective-[1000px]">${state.battle.enemyTeam.map((p,i)=>renderUnit(p,i,false)).join('')}</div>
                        <div class="flex-1 flex items-center justify-center z-20 pointer-events-none"><div id="battle-log" class="glass px-8 py-2 rounded-full text-accent font-black italic text-xs animate-pulse tracking-widest border border-accent/30 shadow-lg">BATTLE START!</div></div>
                        <div class="relative z-10 flex justify-start gap-1 p-6 pb-28 pl-4 perspective-[1000px]">${state.battle.myTeam.map((p,i)=>renderUnit(p,i,true)).join('')}</div>
                    </div>
                `;
            },

            battleLoop: async () => {
                while(state.battle.active) {
                    await wait(1500);
                    const myAlive = state.battle.myTeam.map((p,i)=>({...p, idx:i, t:'p'})).filter(p=>p.currentHp>0);
                    const enAlive = state.battle.enemyTeam.map((p,i)=>({...p, idx:i, t:'e'})).filter(p=>p.currentHp>0);
                    
                    if(myAlive.length === 0) return app.endBattle(false);
                    if(enAlive.length === 0) return app.endBattle(true);

                    const isP = Math.random() > 0.5;
                    const atk = isP ? myAlive[rnd(0,myAlive.length-1)] : enAlive[rnd(0,enAlive.length-1)];
                    const def = isP ? enAlive[rnd(0,enAlive.length-1)] : myAlive[rnd(0,myAlive.length-1)];

                    $('battle-log').innerText = `${atk.name} ATTACKS!`;
                    
                    const atkEl = $(`unit-${atk.t}-${atk.idx}`);
                    const atkSprite = atkEl.querySelector('img');
                    atkEl.style.zIndex = 50;
                    atkSprite.classList.add(isP ? 'anim-atk-p' : 'anim-atk-e');
                    await wait(300);

                    let baseDmg = rnd(25, 40);
                    if(isP && atk.rank === 'S') baseDmg += 20;

                    if(isP) state.battle.enemyTeam[def.idx].currentHp -= baseDmg;
                    else state.battle.myTeam[def.idx].currentHp -= baseDmg;
                    
                    const curHp = isP ? state.battle.enemyTeam[def.idx].currentHp : state.battle.myTeam[def.idx].currentHp;
                    const defEl = $(`unit-${def.t}-${def.idx}`);
                    const hpBar = $(`hp-${def.t}-${def.idx}`);
                    
                    defEl.classList.add('anim-dmg');
                    hpBar.style.width = `${Math.max(0, (curHp/def.maxHp)*100)}%`;
                    if((curHp/def.maxHp)<0.3) hpBar.style.backgroundColor = '#ef4444';

                    await wait(300);
                    atkSprite.classList.remove('anim-atk-p', 'anim-atk-e');
                    defEl.classList.remove('anim-dmg');
                    atkEl.style.zIndex = 10;

                    if(curHp <= 0) {
                        $('battle-log').innerText = `${def.name} FAINTED!`;
                        defEl.querySelector('img').classList.add('sprite-dead');
                        hpBar.parentElement.style.opacity = 0;
                        await wait(1000);
                    }
                }
            },

            endBattle: (win) => {
                state.battle.active = false;
                app.updateCoins(win ? 500 : 50);
                const overlay = document.createElement('div');
                overlay.className = "absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center anim-pop";
                overlay.innerHTML = `
                    <div class="relative mb-6">
                        <div class="absolute inset-0 ${win ? 'bg-accent' : 'bg-red-500'} blur-[80px] opacity-30 rounded-full animate-pulse"></div>
                        <h1 class="text-7xl font-sport font-black italic relative z-10 ${win?'text-accent':'text-gray-500'} tracking-tighter">${win?'VICTORY':'DEFEAT'}</h1>
                    </div>
                    <div class="glass px-8 py-3 rounded-full mb-8 border-l-4 ${win?'border-accent':'border-red-500'}"><span class="text-white font-bold text-xl">+${win?500:50} Coins</span></div>
                    <button onclick="app.nav('lobby'); this.parentElement.remove()" class="bg-white text-black px-12 py-4 rounded-full font-black italic hover:scale-105 transition-transform shadow-xl">RETURN HOME</button>
                `;
                $('app').appendChild(overlay);
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>