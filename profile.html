<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- 화면 배율 고정 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKE RUN: PROFILE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* 폰트 및 테마 설정 */
        :root { --volt: #ccff00; --bg-main: #000000; --bg-card: #111111; --text-main: #ffffff; --text-sub: #9ca3af; --border-color: #262626; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; background: var(--bg-main); color: var(--text-main); font-family: 'Inter', 'Noto Sans KR', sans-serif; touch-action: pan-y; }
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* 모달 애니메이션 */
        .modal-enter { animation: modalFadeIn 0.2s ease-out forwards; }
        .modal-exit { animation: modalFadeOut 0.2s ease-in forwards; }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes modalFadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    </style>
</head>
<body class="flex justify-center h-screen bg-[var(--bg-main)]">

    <!-- 앱 컨테이너 -->
    <div class="w-full max-w-md h-full relative bg-[var(--bg-main)] flex flex-col shadow-2xl border-x border-[var(--border-color)] sm:border-x-0">
        
        <!-- 메인 컨텐츠 영역 -->
        <main class="flex-1 overflow-y-auto pb-20 scrollbar-hide">
            <!-- 프로필 상단 정보 -->
            <div class="px-4 pt-6 pb-6">
                <div class="flex items-center justify-between mb-4">
                    <!-- 프로필 이미지 (클릭 시 확대 대신 편집 유도 가능) -->
                    <div class="relative group cursor-pointer" onclick="openEditProfileModal()">
                        <div class="w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-[var(--volt)] to-purple-500">
                            <img id="my-profile-img" class="w-full h-full rounded-full border-2 border-[var(--bg-main)] object-cover bg-[var(--bg-card)]">
                        </div>
                        <div class="absolute bottom-0 right-0 bg-[var(--volt)] text-black rounded-full p-1 border-2 border-[var(--bg-main)]"><i data-lucide="pencil" class="w-3 h-3"></i></div>
                    </div>
                    
                    <!-- 스탯 정보 -->
                    <div class="flex-1 flex justify-around text-[var(--text-main)] ml-4">
                        <div class="flex flex-col items-center">
                            <span id="post-count" class="font-bold text-lg">0</span>
                            <span class="text-xs text-gray-500">게시물</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="font-bold text-lg">128</span>
                            <span class="text-xs text-gray-500">팔로워</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="font-bold text-lg">45</span>
                            <span class="text-xs text-gray-500">팔로잉</span>
                        </div>
                    </div>
                </div>
                
                <!-- 이름 및 소개 -->
                <div class="mb-5">
                    <h3 id="my-profile-name" class="font-bold text-sm">Loading...</h3>
                    <p id="my-profile-bio" class="text-xs text-gray-500 mt-1">상태 메시지를 입력해주세요.</p>
                </div>
                
                <!-- 버튼 -->
                <div class="flex gap-2 text-sm font-bold">
                    <button onclick="openEditProfileModal()" class="flex-1 bg-[#262626] py-1.5 rounded-lg border border-[#262626] active:scale-95 transition text-white">프로필 편집</button>
                    <button class="flex-1 bg-[#262626] py-1.5 rounded-lg border border-[#262626] active:scale-95 transition text-white">프로필 공유</button>
                </div>
            </div>

            <!-- 탭 메뉴 -->
            <div class="flex border-t border-[var(--border-color)]">
                <button class="flex-1 py-3 border-b-2 border-[var(--text-main)] flex justify-center"><i data-lucide="grid-3x3" class="w-5 h-5"></i></button>
                <button class="flex-1 py-3 flex justify-center text-gray-500"><i data-lucide="clapperboard" class="w-5 h-5"></i></button>
                <button class="flex-1 py-3 flex justify-center text-gray-500"><i data-lucide="user-check" class="w-5 h-5"></i></button>
            </div>

            <!-- 내 게시물 그리드 영역 -->
            <div id="my-post-grid" class="grid grid-cols-3 gap-0.5 pb-2">
                <!-- 로딩 중 스켈레톤 -->
                <div class="bg-[#1a1a1a] aspect-square animate-pulse"></div>
                <div class="bg-[#1a1a1a] aspect-square animate-pulse"></div>
                <div class="bg-[#1a1a1a] aspect-square animate-pulse"></div>
            </div>
            
            <!-- 게시물 없음 표시 -->
            <div id="no-posts-msg" class="hidden py-20 text-center text-gray-500">
                <div class="flex justify-center mb-2"><i data-lucide="camera" class="w-10 h-10 opacity-50"></i></div>
                <p class="text-sm">아직 게시물이 없습니다.</p>
            </div>
        </main>

        <!-- [NEW] 프로필 편집 모달 -->
        <div id="edit-profile-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="w-full max-w-sm bg-[var(--bg-card)] rounded-xl overflow-hidden shadow-2xl border border-[var(--border-color)]">
                <div class="px-4 py-3 flex items-center justify-between border-b border-[var(--border-color)]">
                    <span class="font-bold text-sm">프로필 편집</span>
                    <button onclick="closeEditProfileModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-6 flex flex-col items-center">
                    <!-- 이미지 변경 -->
                    <div class="relative group cursor-pointer mb-6" onclick="document.getElementById('edit-profile-img-input').click()">
                         <div class="w-24 h-24 rounded-full p-[2px] bg-gradient-to-tr from-[var(--volt)] to-purple-500">
                            <img id="edit-profile-preview" class="w-full h-full rounded-full border-2 border-[var(--bg-main)] object-cover bg-[var(--bg-card)]">
                        </div>
                        <div class="absolute bottom-0 right-0 bg-[var(--volt)] text-black rounded-full p-1.5 border-2 border-[var(--bg-main)]">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                        </div>
                        <input type="file" id="edit-profile-img-input" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
                    </div>

                    <!-- 입력 폼 -->
                    <div class="w-full space-y-4">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">닉네임</label>
                            <input type="text" id="edit-nickname" class="w-full bg-[#262626] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--volt)] placeholder-gray-600" placeholder="닉네임 입력">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">상태 메시지</label>
                            <textarea id="edit-bio" rows="3" class="w-full bg-[#262626] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--volt)] placeholder-gray-600 resize-none" placeholder="자신을 소개해보세요."></textarea>
                        </div>
                    </div>

                    <!-- 저장 버튼 -->
                    <button onclick="saveProfile()" class="w-full mt-6 bg-[var(--volt)] hover:bg-[#b3e600] text-black font-bold py-3 rounded-lg transition active:scale-95">
                        완료
                    </button>
                </div>
            </div>
        </div>

        <!-- [업그레이드] 게시물 상세 모달 (삭제 기능 포함) -->
        <div id="post-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closePostModal()">
            <div class="w-full max-w-sm bg-[var(--bg-card)] rounded-xl overflow-hidden shadow-2xl border border-[var(--border-color)] modal-enter" onclick="event.stopPropagation()">
                <!-- 모달 헤더 -->
                <div class="px-4 py-3 flex items-center justify-between border-b border-[var(--border-color)]">
                    <div class="flex items-center gap-2">
                        <img id="modal-avatar" class="w-6 h-6 rounded-full bg-gray-700">
                        <span id="modal-username" class="font-bold text-sm">Username</span>
                    </div>
                    <!-- 삭제 버튼 (내 게시물일 때만 표시) -->
                    <button id="delete-post-btn" class="text-red-500 hidden hover:bg-white/10 p-1 rounded transition" onclick="deleteCurrentPost()">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                <!-- 모달 이미지 -->
                <div class="w-full h-auto bg-black flex items-center justify-center relative min-h-[300px]">
    <img id="modal-image" class="w-full h-auto object-contain max-h-[70vh]">
</div>
                <!-- 모달 하단 정보 -->
                <div class="p-4">
                    <div class="flex gap-4 mb-3">
                        <div class="flex items-center gap-1">
                            <i data-lucide="heart" class="w-6 h-6 text-[var(--volt)] fill-[var(--volt)]"></i>
                            <span id="modal-likes" class="font-bold text-sm">0</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <i data-lucide="message-circle" class="w-6 h-6"></i>
                            <span id="modal-comments" class="font-bold text-sm">0</span>
                        </div>
                        <i data-lucide="send" class="w-6 h-6 transform -rotate-45 mb-1 ml-auto"></i>
                    </div>
                    <div id="modal-content" class="text-sm mt-2 text-white"></div>
                    <div id="modal-date" class="text-[10px] text-gray-500 mt-2 uppercase"></div>
                </div>
            </div>
        </div>

        <!-- 하단 네비게이션 -->
        <nav class="w-full bg-[var(--bg-main)] border-t border-[var(--border-color)] px-2 py-4 flex justify-between items-end pb-8 z-30">
            <button onclick="location.href='log.html'" class="flex-1 flex flex-col items-center gap-1 text-[var(--text-sub)] pb-1">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">피드</span>
            </button>
            <button onclick="location.href='reels.html'" class="flex-1 flex flex-col items-center gap-1 text-[var(--text-sub)] pb-1">
                <i data-lucide="clapperboard" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">릴스</span>
            </button>
            <div class="relative w-16 flex justify-center z-10">
                <button onclick="location.href='upload.html'" class="absolute bottom-2 bg-[var(--volt)] text-black p-3.5 rounded-full border-4 border-black">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </button>
            </div>
            <button onclick="location.reload()" class="flex-1 flex flex-col items-center gap-1 text-[var(--volt)] pb-1">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">프로필</span>
            </button>
            <button onclick="location.href='settings.html'" class="flex-1 flex flex-col items-center gap-1 text-[var(--text-sub)] pb-1">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">설정</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, query, orderByChild, equalTo, update, remove, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0", authDomain: "pokbattle.firebaseapp.com", databaseURL: "https://pokbattle-default-rtdb.firebaseio.com", projectId: "pokbattle", storageBucket: "pokbattle.firebasestorage.app", messagingSenderId: "445300582484", appId: "1:445300582484:web:f8f1373a3bbf643face5c1" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentOpenPostId = null; // 현재 열려있는 게시물 ID 저장용

        // 1. 초기화 및 사용자 로드
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                updateProfileUI(user);
                loadMyPosts(user.uid);
            } else {
                location.href = 'home.html';
            }
        });

        // 사용자 정보 UI 업데이트 함수
        async function updateProfileUI(user) {
            document.getElementById('my-profile-name').innerText = user.displayName || "러너";
            const profileImg = user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`;
            document.getElementById('my-profile-img').src = profileImg;
            document.getElementById('edit-profile-preview').src = profileImg;

            // DB에서 상태메시지(Bio) 가져오기
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            if(snapshot.exists() && snapshot.val().bio) {
                document.getElementById('my-profile-bio').innerText = snapshot.val().bio;
            } else {
                document.getElementById('my-profile-bio').innerText = "상태 메시지를 입력해주세요.";
            }
        }

        // 2. 내 게시물 불러오기
        function loadMyPosts(userId) {
            const grid = document.getElementById('my-post-grid');
            const postsRef = ref(db, 'posts');

            onValue(postsRef, (snapshot) => {
                grid.innerHTML = "";
                const data = snapshot.val();
                
                if (!data) {
                    showNoPosts();
                    return;
                }

                // 내 게시물 필터링 및 최신순 정렬
                const myPosts = Object.entries(data)
                    .filter(([key, post]) => post.author === userId)
                    .sort((a, b) => b[1].timestamp - a[1].timestamp);
                
                document.getElementById('post-count').innerText = myPosts.length;

                if (myPosts.length === 0) {
                    showNoPosts();
                    return;
                }

                document.getElementById('no-posts-msg').classList.add('hidden');

                myPosts.forEach(([key, post]) => {
                    const div = document.createElement('div');
                    div.className = "relative h-auto bg-black cursor-pointer group overflow-hidden mb-1"; 
div.innerHTML = `
    <img src="${post.image}" class="w-full h-auto object-contain" loading="lazy">
    ...
`;
                    div.onclick = () => openPostModal(post, key);

                    // 좋아요 및 댓글 수 계산
                    const likesCount = post.likes ? Object.keys(post.likes).length : 0;
                    const commentsCount = post.comments ? Object.keys(post.comments).length : 0;

                    div.innerHTML = `
                        <img src="${post.image}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy">
                        <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center gap-4 text-white font-bold opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="flex items-center"><i data-lucide="heart" class="w-5 h-5 mr-1 fill-white"></i> ${likesCount}</div>
                            <div class="flex items-center"><i data-lucide="message-circle" class="w-5 h-5 mr-1 fill-white"></i> ${commentsCount}</div>
                        </div>
                    `;
                    grid.appendChild(div);
                });
                lucide.createIcons();
            });
        }

        function showNoPosts() {
            document.getElementById('my-post-grid').innerHTML = "";
            document.getElementById('no-posts-msg').classList.remove('hidden');
            document.getElementById('post-count').innerText = "0";
        }

        // 3. 게시물 상세 모달
        window.openPostModal = (post, postId) => {
            currentOpenPostId = postId;
            const modal = document.getElementById('post-modal');
            const likes = post.likes ? Object.keys(post.likes).length : 0;
            const comments = post.comments ? Object.keys(post.comments).length : 0;

            document.getElementById('modal-image').src = post.image;
            document.getElementById('modal-avatar').src = post.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.author}`;
            document.getElementById('modal-username').innerText = post.authorName;
            document.getElementById('modal-likes').innerText = likes;
            document.getElementById('modal-comments').innerText = comments;
            document.getElementById('modal-content').innerText = post.content;
            document.getElementById('modal-date').innerText = new Date(post.timestamp).toLocaleDateString();

            // 내 게시물이면 삭제 버튼 표시
            const deleteBtn = document.getElementById('delete-post-btn');
            if(currentUser && post.author === currentUser.uid) {
                deleteBtn.classList.remove('hidden');
            } else {
                deleteBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        window.closePostModal = () => {
            document.getElementById('post-modal').classList.add('hidden');
            currentOpenPostId = null;
        };

        // 4. 게시물 삭제 기능
        window.deleteCurrentPost = async () => {
            if(!currentOpenPostId) return;
            
            if(confirm("정말로 이 게시물을 삭제하시겠습니까?")) {
                try {
                    await remove(ref(db, `posts/${currentOpenPostId}`));
                    closePostModal();
                    // 삭제 후 로드는 onValue 리스너가 자동 처리함
                } catch(e) {
                    console.error("삭제 실패", e);
                    alert("게시물 삭제 중 오류가 발생했습니다.");
                }
            }
        };

        // 5. 프로필 편집 모달 관련
        window.openEditProfileModal = () => {
            if(!currentUser) return;
            
            // 기존 값 채워넣기
            document.getElementById('edit-nickname').value = currentUser.displayName || "";
            document.getElementById('edit-bio').value = document.getElementById('my-profile-bio').innerText !== "상태 메시지를 입력해주세요." ? document.getElementById('my-profile-bio').innerText : "";
            document.getElementById('edit-profile-preview').src = document.getElementById('my-profile-img').src;
            
            document.getElementById('edit-profile-modal').classList.remove('hidden');
        };

        window.closeEditProfileModal = () => {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        };

        // 프로필 이미지 미리보기
        window.previewProfileImage = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('edit-profile-preview').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // 프로필 저장
        window.saveProfile = async () => {
            if(!currentUser) return;

            const newNickname = document.getElementById('edit-nickname').value;
            const newBio = document.getElementById('edit-bio').value;
            const imgInput = document.getElementById('edit-profile-img-input');
            
            let newPhotoURL = currentUser.photoURL;

            // 로딩 표시 (버튼 텍스트 변경 등)
            const saveBtn = document.querySelector('#edit-profile-modal button:last-child');
            const originalText = saveBtn.innerText;
            saveBtn.innerText = "저장 중...";
            saveBtn.disabled = true;

            try {
                // 1. 이미지 변경 확인
                if(imgInput.files && imgInput.files[0]) {
                    // 실제 서비스에선 Storage에 업로드해야 하나, 여기선 DataURL(Base64) 사용 (간이 구현)
                    // 긴 Base64 문자열은 Auth 프로필 제한에 걸릴 수 있으나 테스트용으로 진행
                    // (실제 프로덕션에선 Firebase Storage 사용 권장)
                    newPhotoURL = document.getElementById('edit-profile-preview').src;
                }

                // 2. Auth 프로필 업데이트 (이름, 사진)
                await updateProfile(currentUser, {
                    displayName: newNickname,
                    photoURL: newPhotoURL
                });

                // 3. DB에 추가 정보(Bio) 및 유저 정보 동기화 저장
                const updates = {};
                updates[`users/${currentUser.uid}/nickname`] = newNickname;
                updates[`users/${currentUser.uid}/photoURL`] = newPhotoURL;
                updates[`users/${currentUser.uid}/bio`] = newBio;
                
                await update(ref(db), updates);

                // 4. UI 갱신 및 모달 닫기
                updateProfileUI(currentUser); // 화면 즉시 갱신
                // Bio는 updateProfileUI 내부에서 다시 fetch하거나 여기서 수동 업데이트
                document.getElementById('my-profile-bio').innerText = newBio || "상태 메시지를 입력해주세요.";
                
                closeEditProfileModal();
                alert("프로필이 업데이트되었습니다.");

            } catch (error) {
                console.error("프로필 저장 실패:", error);
                alert("프로필 저장 중 오류가 발생했습니다: " + error.message);
            } finally {
                saveBtn.innerText = originalText;
                saveBtn.disabled = false;
            }
        };

        lucide.createIcons();
    </script>
</body>
</html>