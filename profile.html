<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- í™”ë©´ ë°°ìœ¨ ê³ ì • (í•„ìˆ˜ ì„¤ì • ìœ ì§€) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKE RUN: PROFILE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* í°íŠ¸ ë° í…Œë§ˆ ì„¤ì • (ìœ ì§€) */
        :root { --volt: #ccff00; --bg-main: #000000; --bg-card: #111111; --text-main: #ffffff; --text-sub: #9ca3af; --border-color: #262626; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; background: var(--bg-main); color: var(--text-main); font-family: 'Inter', 'Noto Sans KR', sans-serif; touch-action: pan-y; }
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
    </style>
</head>
<body class="flex justify-center h-screen bg-[var(--bg-main)]">

    <!-- ì•± ì»¨í…Œì´ë„ˆ -->
    <div class="w-full max-w-md h-full relative bg-[var(--bg-main)] flex flex-col shadow-2xl border-x border-[var(--border-color)] sm:border-x-0">
        
        <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
        <main class="flex-1 overflow-y-auto pb-20 scrollbar-hide">
            <!-- í”„ë¡œí•„ ìƒë‹¨ ì •ë³´ -->
            <div class="px-4 pt-6 pb-6">
                <div class="flex items-center justify-between mb-4">
                    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
                    <div class="relative group cursor-pointer" onclick="document.getElementById('profile-img-input').click()">
                        <div class="w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-[var(--volt)] to-purple-500">
                            <img id="my-profile-img" class="w-full h-full rounded-full border-2 border-[var(--bg-main)] object-cover bg-[var(--bg-card)]">
                        </div>
                        <div class="absolute bottom-0 right-0 bg-[var(--volt)] text-black rounded-full p-1 border-2 border-[var(--bg-main)]"><i data-lucide="plus" class="w-3 h-3"></i></div>
                        <input type="file" id="profile-img-input" class="hidden" accept="image/*" onchange="uploadProfileImage(this)">
                    </div>
                    
                    <!-- ìŠ¤íƒ¯ ì •ë³´ (ê²Œì‹œë¬¼/íŒ”ë¡œì›Œ/íŒ”ë¡œì‰) -->
                    <div class="flex-1 flex justify-around text-[var(--text-main)] ml-4">
                        <div class="flex flex-col items-center">
                            <span id="post-count" class="font-bold text-lg">0</span>
                            <span class="text-xs text-gray-500">ê²Œì‹œë¬¼</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="font-bold text-lg">128</span>
                            <span class="text-xs text-gray-500">íŒ”ë¡œì›Œ</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="font-bold text-lg">45</span>
                            <span class="text-xs text-gray-500">íŒ”ë¡œì‰</span>
                        </div>
                    </div>
                </div>
                
                <!-- ì´ë¦„ ë° ì†Œê°œ -->
                <div class="mb-5">
                    <h3 id="my-profile-name" class="font-bold text-sm">Loading...</h3>
                    <p class="text-xs text-gray-500 mt-1">ì˜¤ëŠ˜ë„ ì¦ê²ê²Œ ë‹¬ë¦¬ê¸° ğŸƒâ€â™‚ï¸ğŸ’¨</p>
                </div>
                
                <!-- ë²„íŠ¼ -->
                <div class="flex gap-2 text-sm font-bold">
                    <button class="flex-1 bg-[#262626] py-1.5 rounded-lg border border-[#262626] active:scale-95 transition">í”„ë¡œí•„ í¸ì§‘</button>
                    <button class="flex-1 bg-[#262626] py-1.5 rounded-lg border border-[#262626] active:scale-95 transition">í”„ë¡œí•„ ê³µìœ </button>
                </div>
            </div>

            <!-- íƒ­ ë©”ë‰´ (ì•„ì´ì½˜) -->
            <div class="flex border-t border-[var(--border-color)]">
                <button class="flex-1 py-3 border-b-2 border-[var(--text-main)] flex justify-center"><i data-lucide="grid-3x3" class="w-5 h-5"></i></button>
                <button class="flex-1 py-3 flex justify-center text-gray-500"><i data-lucide="clapperboard" class="w-5 h-5"></i></button>
                <button class="flex-1 py-3 flex justify-center text-gray-500"><i data-lucide="user-check" class="w-5 h-5"></i></button>
            </div>

            <!-- [ìˆ˜ì •ë¨] ë‚´ ê²Œì‹œë¬¼ ê·¸ë¦¬ë“œ ì˜ì—­ -->
            <div id="my-post-grid" class="grid grid-cols-3 gap-0.5 pb-2">
                <!-- ë¡œë”© ì¤‘ ìŠ¤ì¼ˆë ˆí†¤ -->
                <div class="bg-[#1a1a1a] aspect-square animate-pulse"></div>
                <div class="bg-[#1a1a1a] aspect-square animate-pulse"></div>
                <div class="bg-[#1a1a1a] aspect-square animate-pulse"></div>
            </div>
            
            <!-- ê²Œì‹œë¬¼ ì—†ìŒ í‘œì‹œ (ìˆ¨ê¹€ ìƒíƒœ) -->
            <div id="no-posts-msg" class="hidden py-20 text-center text-gray-500">
                <div class="flex justify-center mb-2"><i data-lucide="camera" class="w-10 h-10 opacity-50"></i></div>
                <p class="text-sm">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </main>

        <!-- [ì¶”ê°€ë¨] ê²Œì‹œë¬¼ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ (ì¸ìŠ¤íƒ€ ìŠ¤íƒ€ì¼) -->
        <div id="post-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closePostModal()">
            <div class="w-full max-w-sm bg-[var(--bg-card)] rounded-xl overflow-hidden shadow-2xl border border-[var(--border-color)]" onclick="event.stopPropagation()">
                <!-- ëª¨ë‹¬ í—¤ë” -->
                <div class="px-4 py-3 flex items-center justify-between border-b border-[var(--border-color)]">
                    <div class="flex items-center gap-2">
                        <img id="modal-avatar" class="w-6 h-6 rounded-full bg-gray-700">
                        <span id="modal-username" class="font-bold text-sm">Username</span>
                    </div>
                    <button onclick="closePostModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <!-- ëª¨ë‹¬ ì´ë¯¸ì§€ -->
                <div class="aspect-square bg-black flex items-center justify-center">
                    <img id="modal-image" class="w-full h-full object-cover">
                </div>
                <!-- ëª¨ë‹¬ í•˜ë‹¨ ì •ë³´ -->
                <div class="p-4">
                    <div class="flex gap-4 mb-3">
                        <i data-lucide="heart" class="w-6 h-6 text-[var(--volt)] fill-[var(--volt)]"></i>
                        <i data-lucide="message-circle" class="w-6 h-6"></i>
                        <i data-lucide="send" class="w-6 h-6 transform -rotate-45 mb-1"></i>
                    </div>
                    <div class="text-sm font-bold mb-1">ì¢‹ì•„ìš” <span id="modal-likes">0</span>ê°œ</div>
                    <div class="text-sm text-gray-400">ëŒ“ê¸€ <span id="modal-comments">0</span>ê°œ</div>
                    <div id="modal-content" class="text-sm mt-2 text-white"></div>
                    <div id="modal-date" class="text-[10px] text-gray-500 mt-2 uppercase"></div>
                </div>
            </div>
        </div>

        <!-- [ìœ ì§€] ë¦´ìŠ¤ ê·œê²©ìœ¼ë¡œ í†µì¼ëœ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="w-full bg-[var(--bg-main)] border-t border-[var(--border-color)] px-2 py-4 flex justify-between items-end pb-8 z-30">
            <!-- 1. í”¼ë“œ -->
            <button onclick="location.href='log.html'" class="flex-1 flex flex-col items-center gap-1 text-[var(--text-sub)] pb-1">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">í”¼ë“œ</span>
            </button>
            
            <!-- 2. ë¦´ìŠ¤ -->
            <button onclick="location.href='reels.html'" class="flex-1 flex flex-col items-center gap-1 text-[var(--text-sub)] pb-1">
                <i data-lucide="clapperboard" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ë¦´ìŠ¤</span>
            </button>
            
            <!-- 3. ì—…ë¡œë“œ -->
            <div class="relative w-16 flex justify-center z-10">
                <button onclick="location.href='upload.html'" class="absolute bottom-2 bg-[var(--volt)] text-black p-3.5 rounded-full border-4 border-black">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </button>
            </div>
        
            <!-- 4. í”„ë¡œí•„ (í™œì„± ìƒíƒœ) -->
            <button onclick="location.reload()" class="flex-1 flex flex-col items-center gap-1 text-[var(--volt)] pb-1">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">í”„ë¡œí•„</span>
            </button>
            
            <!-- 5. ì„¤ì • -->
            <button onclick="location.href='settings.html'" class="flex-1 flex flex-col items-center gap-1 text-[var(--text-sub)] pb-1">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ì„¤ì •</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0", authDomain: "pokbattle.firebaseapp.com", databaseURL: "https://pokbattle-default-rtdb.firebaseio.com", projectId: "pokbattle", storageBucket: "pokbattle.firebasestorage.app", messagingSenderId: "445300582484", appId: "1:445300582484:web:f8f1373a3bbf643face5c1" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;

        // 1. ì¸ì¦ ìƒíƒœ í™•ì¸ ë° í”„ë¡œí•„ ë¡œë“œ
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('my-profile-name').innerText = user.displayName || "ëŸ¬ë„ˆ";
                document.getElementById('my-profile-img').src = user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`;
                loadMyPosts(user.uid); // ë‚´ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
                location.href = 'home.html';
            }
        });

        // 2. ë‚´ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸° (ì¸ìŠ¤íƒ€ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼)
        function loadMyPosts(userId) {
            const grid = document.getElementById('my-post-grid');
            const postsRef = ref(db, 'posts');

            onValue(postsRef, (snapshot) => {
                grid.innerHTML = ""; // ì´ˆê¸°í™”
                const data = snapshot.val();
                
                if (!data) {
                    grid.innerHTML = "";
                    document.getElementById('no-posts-msg').classList.remove('hidden');
                    document.getElementById('post-count').innerText = "0";
                    return;
                }

                // ë‚´ ê²Œì‹œë¬¼ë§Œ í•„í„°ë§
                const myPosts = Object.entries(data).filter(([key, post]) => post.author === userId).reverse(); // ìµœì‹ ìˆœ
                
                document.getElementById('post-count').innerText = myPosts.length;

                if (myPosts.length === 0) {
                    document.getElementById('no-posts-msg').classList.remove('hidden');
                    return;
                }

                document.getElementById('no-posts-msg').classList.add('hidden');

                myPosts.forEach(([key, post]) => {
                    // ê·¸ë¦¬ë“œ ì•„ì´í…œ ìƒì„±
                    const div = document.createElement('div');
                    div.className = "relative aspect-square bg-[#1a1a1a] cursor-pointer group overflow-hidden";
                    div.onclick = () => openPostModal(post, key); // í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ

                    div.innerHTML = `
                        <img src="${post.image}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy">
                        <!-- í˜¸ë²„ ì‹œ ì¢‹ì•„ìš”/ëŒ“ê¸€ ìˆ˜ ì˜¤ë²„ë ˆì´ -->
                        <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center gap-4 text-white font-bold opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="flex items-center"><i data-lucide="heart" class="w-5 h-5 mr-1 fill-white"></i> ${post.likes ? Object.keys(post.likes).length : 0}</div>
                            <div class="flex items-center"><i data-lucide="message-circle" class="w-5 h-5 mr-1 fill-white"></i> ${post.comments ? Object.keys(post.comments).length : 0}</div>
                        </div>
                    `;
                    grid.appendChild(div);
                });
                lucide.createIcons();
            });
        }

        // 3. ê²Œì‹œë¬¼ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        window.openPostModal = (post, postId) => {
            const modal = document.getElementById('post-modal');
            const likes = post.likes ? Object.keys(post.likes).length : 0;
            const comments = post.comments ? Object.keys(post.comments).length : 0;

            document.getElementById('modal-image').src = post.image;
            document.getElementById('modal-avatar').src = post.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.author}`;
            document.getElementById('modal-username').innerText = post.authorName;
            document.getElementById('modal-likes').innerText = likes;
            document.getElementById('modal-comments').innerText = comments;
            document.getElementById('modal-content').innerText = post.content;
            document.getElementById('modal-date').innerText = new Date(post.timestamp).toLocaleDateString();

            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        // 4. ëª¨ë‹¬ ë‹«ê¸°
        window.closePostModal = () => {
            document.getElementById('post-modal').classList.add('hidden');
        };

        // 5. í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
        window.uploadProfileImage = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const newImg = e.target.result;
                    document.getElementById('my-profile-img').src = newImg;
                    if (auth.currentUser) {
                        await updateProfile(auth.currentUser, { photoURL: newImg });
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        lucide.createIcons();
    </script>
</body>
</html>