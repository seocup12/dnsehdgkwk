<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POKÃ‰ RUN: BATTLE RECORDS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,900&family=Inter:wght@400;0,700;0,900&family=Noto+Sans+KR:wght@400;0,700;0,900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. ê¸°ë³¸ í…Œë§ˆ (ë‹¤í¬ ëª¨ë“œ, BLACK) ë³€ìˆ˜ --- */
        :root { 
            --volt: #2563eb; /* ë¸”ë£¨ */
            --bg-main: #ffffff;
            --bg-card: #f3f4f6;
            --bg-sub: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #d1d5db; 
        }
        
        /* âšª 2. í™”ì´íŠ¸ ëª¨ë“œ ë””ìì¸ ë³€ìˆ˜ ì ìš© (WHITE) */
        .white-mode {
            --volt: #2563eb; /* ë¸”ë£¨ */
            --bg-main: #ffffff;
            --bg-card: #f3f4f6;
            --bg-sub: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #d1d5db;
        }

        /* 3. í°íŠ¸ ë° ê³µí†µ ìŠ¤íƒ€ì¼ */
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        body { 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            font-family: 'Noto Sans KR', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
    </style>
</head>
<body class="bg-[var(--bg-main)] min-h-screen"> 
    
    <main class="max-w-xl mx-auto container">
        <div id="profile-content" class="p-4 opacity-100 transition-opacity duration-500">
            
            <div id="battle-records" class="pt-6"> 
                <h4 class="text-lg font-bold font-sport text-[var(--volt)] mb-4 pb-2 border-b border-[var(--border-color)]">ëˆ„ì  ëŒ€ì „ ê¸°ë¡</h4> 
                
                <div class="grid grid-cols-2 gap-3 text-center">
                    <button id="btn-win" onclick="toggleBattleHistory('win')" class="bg-[var(--bg-sub)] p-4 rounded-xl shadow-lg transition-all hover:ring-2 hover:ring-[var(--volt)] active:ring-4 active:ring-[var(--volt)] active:scale-[0.98]">
                        <span id="win-count-total" class="font-bold text-4xl font-sport text-green-400">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">WIN (ìŠ¹)</span>
                    </button>
                    <button id="btn-lose" onclick="toggleBattleHistory('lose')" class="bg-[var(--bg-sub)] p-4 rounded-xl shadow-lg transition-all hover:ring-2 hover:ring-[var(--volt)] active:ring-4 active:ring-[var(--volt)] active:scale-[0.98]">
                        <span id="lose-count-total" class="font-bold text-4xl font-sport text-red-400">0</span>
                        <span class="text-xs text-[var(--text-sub)] block mt-1">LOSE (íŒ¨)</span>
                    </button>
                </div>
            </div>
            
            <div id="battle-history" class="mt-6 hidden">
                <h5 id="history-title" class="text-md font-bold text-[var(--text-main)] mb-3">ì „íˆ¬ ìƒì„¸ ê¸°ë¡</h5>
                <ul id="history-list" class="space-y-2">
                    </ul>
            </div>
            </div>
    </main>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    
    <script>
        // ğŸš¨ğŸš¨ğŸš¨ ì‚¬ìš©ìë‹˜ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì • ğŸš¨ğŸš¨ğŸš¨
        const firebaseConfig = {
             apiKey: "AIzaSyAbHwLLXIH8rBQ8gNMVqE5SE208aIbfFZ0",
             authDomain: "pokbattle.firebaseapp.com",
             databaseURL: "https://pokbattle-default-rtdb.firebaseio.com",
             projectId: "pokbattle",
             storageBucket: "pokbattle.firebasestorage.app",
             messagingSenderId: "445300582484",
             appId: "1:445300582484:web:f8f1373a3bbf643face5c1"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let currentPokemonId = null; 

        // ğŸ†• ë°°í‹€ ê¸°ë¡ ë”ë¯¸ ë°ì´í„° (í¬ì¼“ëª¬ ì •ë³´ ì¶”ê°€)
        const dummyBattleHistory = [
            { id: 1, date: "2025-12-09 14:30", result: "ìŠ¹ë¦¬", opponent: "ë¼ì´ì¸„", myPokemon: "í”¼ì¹´ì¸„", opponentPokemon: "ë¼ì´ì¸„", reason: "ê¸°ìˆ ë ¥ ìš°ìœ„" },
            { id: 2, date: "2025-12-08 10:15", result: "íŒ¨ë°°", opponent: "ê¼¬ë¶€ê¸°", myPokemon: "íŒŒì´ë¦¬", opponentPokemon: "ê¼¬ë¶€ê¸°", reason: "ìƒì„± ë¶ˆë¦¬" },
            { id: 3, date: "2025-12-07 18:00", result: "ìŠ¹ë¦¬", opponent: "ì´ìƒí•´ì”¨", myPokemon: "í”¼ì¹´ì¸„", opponentPokemon: "ì´ìƒí•´ì”¨", reason: "ìŠ¤í”¼ë“œ ìš°ìœ„" },
            { id: 4, date: "2025-12-06 09:00", result: "íŒ¨ë°°", opponent: "ë§ë‚˜ë‡½", myPokemon: "íŒŒì´ë¦¬", opponentPokemon: "ë§ë‚˜ë‡½", reason: "ë ˆë²¨ ì°¨ì´" },
            { id: 5, date: "2025-12-05 12:00", result: "ìŠ¹ë¦¬", opponent: "ë®¤ì¸ ", myPokemon: "ë¦¬ìëª½", opponentPokemon: "ë®¤ì¸ ", reason: "ê·¹ì ì¸ ìŠ¹ë¦¬" },
        ];
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let allBattleHistory = [];
        let currentFilter = null; // 'win', 'lose', or null

        // UI ì—…ë°ì´íŠ¸ë¥¼ í†µí•©í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ (ì „ì ë§Œ ì²˜ë¦¬)
        function updateUI(data) {
            // ì „ì  íƒ­ì— ë°ì´í„° ì—…ë°ì´íŠ¸
            const battle = data.battle || {};
            document.getElementById('win-count-total').innerText = battle.wins || 0;
            document.getElementById('lose-count-total').innerText = battle.loses || 0;
            // drawëŠ” UIì—ì„œ ì œê±°ë¨
        }

        // ------------------------------------
        // ğŸ†• ë°°í‹€ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜ (í•„í„°ë§ í¬í•¨)
        // ------------------------------------
        function renderBattleHistory(historyData, filter) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            // í•„í„°ë§ ë¡œì§
            const filteredData = historyData.filter(record => {
                if (filter === 'win') return record.result === "ìŠ¹ë¦¬";
                if (filter === 'lose') return record.result === "íŒ¨ë°°";
                return true; // í•„í„°ê°€ ì—†ìœ¼ë©´ ëª¨ë‘ í‘œì‹œ (ì‹¤ì œë¡œëŠ” í•„í„°ê°€ í•­ìƒ ì ìš©ë¨)
            });
            
            if (filteredData.length === 0) {
                 historyList.innerHTML = `<li class="p-3 bg-[var(--bg-sub)] rounded-lg text-sm text-[var(--text-sub)] text-center">ê¸°ë¡ëœ ${filter === 'win' ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'} ì „íˆ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
                 return;
            }

            filteredData.forEach(record => {
                const isWin = record.result === "ìŠ¹ë¦¬";
                const resultClass = isWin ? 'text-green-400' : 'text-red-400';
                const icon = isWin ? 'trophy' : 'swords';
                const item = document.createElement('li');
                item.className = "p-3 bg-[var(--bg-sub)] rounded-lg border border-[var(--border-color)] flex justify-between items-center";
                
                // â­ï¸ [ìˆ˜ì •] ë‚´ í¬ì¼“ëª¬ vs ìƒëŒ€ í¬ì¼“ëª¬ í‘œì‹œ â­ï¸
                item.innerHTML = `
                    <div>
                        <span class="font-bold ${resultClass}">${record.result}</span> | ${record.myPokemon || 'Unknown'} vs ${record.opponentPokemon || 'Unknown'}
                        <p class="text-[10px] text-[var(--text-sub)] mt-0.5">${record.date} (${record.reason || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'})</p>
                    </div>
                    <i data-lucide="${icon}" class="w-5 h-5 ${resultClass}"></i>
                `;
                historyList.appendChild(item);
            });
            lucide.createIcons();
        }


        // ------------------------------------
        // ğŸ†• ìŠ¹/íŒ¨ ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ë¡ í† ê¸€ í•¨ìˆ˜ (í•„í„° ê´€ë¦¬)
        // ------------------------------------
        window.toggleBattleHistory = function(filterType) {
            const historyDiv = document.getElementById('battle-history');
            const historyTitle = document.getElementById('history-title');
            const btnWin = document.getElementById('btn-win');
            const btnLose = document.getElementById('btn-lose');
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (ì„ íƒë˜ì§€ ì•Šì€ ë²„íŠ¼ì˜ ë¶ˆ ë„ê¸°)
            btnWin.classList.remove('ring-4', 'ring-[var(--volt)]');
            btnLose.classList.remove('ring-4', 'ring-[var(--volt)]');
            
            if (currentFilter === filterType) {
                // ì´ë¯¸ í•´ë‹¹ í•„í„°ê°€ í™œì„±í™”ëœ ê²½ìš° -> ë‹«ê¸° (í† ê¸€)
                historyDiv.classList.add('hidden');
                currentFilter = null;
            } else {
                // ìƒˆë¡œìš´ í•„í„° í™œì„±í™”
                currentFilter = filterType;
                
                // ì œëª© ì—…ë°ì´íŠ¸
                historyTitle.innerText = `${currentFilter === 'win' ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'} ì „íˆ¬ ìƒì„¸ ê¸°ë¡`;
                
                // ë²„íŠ¼ì— í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš© (ë¶ˆ ì¼œê¸°)
                if (filterType === 'win') {
                    btnWin.classList.add('ring-4', 'ring-[var(--volt)]');
                } else {
                    btnLose.classList.add('ring-4', 'ring-[var(--volt)]');
                }

                // ê¸°ë¡ ë Œë”ë§ ë° í‘œì‹œ
                renderBattleHistory(allBattleHistory, currentFilter);
                historyDiv.classList.remove('hidden');
            }
        }


        // ===============================================
        // 1. í•µì‹¬ ê¸°ëŠ¥: í¬ì¼“ëª¬ í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
        // ===============================================
        window.loadPokemonProfile = async (pokemonId) => {
            const profileContent = document.getElementById('profile-content');
            
            profileContent.classList.add('opacity-100'); // ìƒë‹¨ UIê°€ ì—†ìœ¼ë¯€ë¡œ ì¦‰ì‹œ í‘œì‹œ

            if (!pokemonId || pokemonId === 'dummy_test') {
                // ë”ë¯¸ ë°ì´í„° ë¡œë“œ (ID ëˆ„ë½ ì‹œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ìš©)
                const dummyData = {
                    battle: { wins: 30, loses: 10, draws: 0 }, 
                };
                updateUI(dummyData);
                currentPokemonId = 'dummy_test'; 
                // ğŸ†• ì „ì—­ ë³€ìˆ˜ì— ë”ë¯¸ ê¸°ë¡ ì €ì¥
                allBattleHistory = dummyBattleHistory;

            } else {
                // â­ï¸ ì‹¤ì œ Firebase ë°ì´í„° ë¡œë“œ (ë‹¨ì¼ í”„ë¡œí•„) â­ï¸
                try {
                    const snap = await db.ref(`pokemon_profiles/${pokemonId}`).once('value');
                    
                    if (snap.exists()) {
                        const data = snap.val();
                        updateUI(data);
                        // ğŸ†• ì „ì—­ ë³€ìˆ˜ì— ì‹¤ì œ ê¸°ë¡ ì €ì¥ (battleHistory í•„ë“œê°€ ìˆë‹¤ê³  ê°€ì •)
                        allBattleHistory = data.battleHistory || []; 
                    } else {
                        updateUI({}); 
                        allBattleHistory = [];
                        // ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬ëŠ” ìƒë‹¨ UI ì‚­ì œë¡œ ì¸í•´ ê°„ì†Œí™”ë¨
                    }
                    currentPokemonId = pokemonId; 

                } catch (error) {
                    console.error("ğŸ”¥ í¬ì¼“ëª¬ í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:", error);
                    updateUI({}); 
                    allBattleHistory = [];
                }
            }
            
            // ğŸ†• ì´ˆê¸°í™”: ìƒì„¸ ê¸°ë¡ì€ ìˆ¨ê²¨ì ¸ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
            document.getElementById('battle-history').classList.add('hidden');
            currentFilter = null;
            lucide.createIcons();
        };

        // ===============================================
        // 2. UI ê³µí†µ ê¸°ëŠ¥ (í…Œë§ˆ) - ì´ì œ ì´ íŒŒì¼ì—ëŠ” í•„ìš” ì—†ì§€ë§Œ loadThemeë§Œ ë‚¨ê²¨ë‘ 
        // ===============================================
        
        window.loadTheme = () => {
            if (localStorage.getItem('theme') === 'white') {
                document.body.classList.add('white-mode');
            }
        };

        // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
        window.onload = () => {
            loadTheme();
            const urlParams = new URLSearchParams(window.location.search);
            currentPokemonId = urlParams.get('id'); 

            // IDê°€ ì—†ìœ¼ë©´ 'dummy_test'ë¡œ ë¡œë“œ (í…ŒìŠ¤íŠ¸ìš©)
            loadPokemonProfile(currentPokemonId || 'dummy_test'); 
        };
    </script>
</body>
</html>